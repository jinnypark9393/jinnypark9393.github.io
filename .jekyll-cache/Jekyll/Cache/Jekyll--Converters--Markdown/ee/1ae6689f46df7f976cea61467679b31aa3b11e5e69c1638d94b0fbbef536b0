I"{$<p><br /><br /></p>

<p><em>ğŸ’¡  ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ì„ ì•Œì•„ë³´ê¸°ì— ì•ì„œ ë¦¬ëˆ…ìŠ¤ì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ëŒ€í•´ ì•Œì•„ë³´ì.</em></p>

<p><br /></p>

<h1 id="1-linux-namespaces">1. Linux Namespaces</h1>

<h2 id="1-ë„¤ì„ìŠ¤í˜ì´ìŠ¤">1. ë„¤ì„ìŠ¤í˜ì´ìŠ¤</h2>

<ul>
  <li>í˜¸ìŠ¤íŠ¸ ì•ˆì˜ ê²©ë¦¬ëœ ê³µê°„(ì§‘ ì•ˆì— ë°©ì´ ìˆëŠ” ê²ƒê³¼ ê°™ìŒ): ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•  ë•Œ ì»¨í…Œì´ë„ˆë¥¼ ê²©ë¦¬í•´ ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆê°€ í‘œì‹œë˜ì§€ ì•Šë„ë¡ í•˜ê³  ì‹¶ì€ ê²½ìš°</li>
  <li>ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì•ˆì˜ ì»¨í…Œì´ë„ˆ â‡’ ìê¸°ìì‹ ë§Œ ë³¼ ìˆ˜ ìˆìŒ</li>
  <li>Underlying (ê¸°ë³¸) í˜¸ìŠ¤íŠ¸: ëª¨ë“  í”„ë¡œì„¸ìŠ¤ë¥¼ ë³¼ ìˆ˜ ìˆìŒ
    <ul>
      <li><code class="language-plaintext highlighter-rouge">ps aux</code> ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŒ â‡’ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ë¶€/ì™¸ë¶€ì—ì„œ ê°™ì€ í”„ë¡œì„¸ìŠ¤ì§€ë§Œ PIDê°€ ìƒì´í•˜ê²Œ ë¨</li>
      <li>í˜¸ìŠ¤íŠ¸
        <ul>
          <li>LANì— ì—°ê²°í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ ì¡´ì¬</li>
          <li>ë¼ìš°íŒ… í…Œì´ë¸”</li>
          <li>ARP í…Œì´ë¸”: IP - MAC ì£¼ì†Œ ì¼ëŒ€ì¼ ëŒ€ì‘í•œ í…Œì´ë¸”</li>
        </ul>

        <p>â‡’ ì»¨í…Œì´ë„ˆì—ì„œ ìœ„ ì„¸ë¶€ì‚¬í•­ì„ ë³´ì´ì§€ ì•Šê²Œ í•˜ê³  ì‹¶ë‹¤ë©´?</p>
      </li>
    </ul>
  </li>
</ul>

<p><br /></p>

<ul>
  <li>ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì— ì»¨í…Œì´ë„ˆ ìƒì„± ì‹œ í˜¸ìŠ¤íŠ¸ì— ëŒ€í•œ ë„¤íŠ¸ì›Œí¬ ì •ë³´ì— ëŒ€í•œ ê°€ì‹œì„± ì—†ì–´ì§
    <ul>
      <li>ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ìì²´ ê°€ìƒ ì¸í„°í˜ì´ìŠ¤(veth) ë° ë¼ìš°íŒ… í…Œì´ë¸”/ARP í…Œì´ë¸”ì„ ê°€ì§ˆ ìˆ˜ ìˆìŒ</li>
    </ul>
  </li>
</ul>

<p><br /><br /></p>

<h2 id="2-ë„¤íŠ¸ì›Œí¬-ë„¤ì„ìŠ¤í˜ì´ìŠ¤-ìƒì„±">2. ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±</h2>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ip netns add red</code></li>
  <li><code class="language-plaintext highlighter-rouge">ip netns add blue</code></li>
  <li><code class="language-plaintext highlighter-rouge">ip netns</code></li>
  <li><code class="language-plaintext highlighter-rouge">ip link</code> : host ì˜ ì¸í„°í˜ì´ìŠ¤ í™•ì¸</li>
  <li><code class="language-plaintext highlighter-rouge">ip netns exec red ip link</code> : ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ ì¸í„°í˜ì´ìŠ¤ í™•ì¸ (= <code class="language-plaintext highlighter-rouge">ip -n red link</code> )</li>
</ul>

<p><br /><br /></p>

<h2 id="3-ë„¤íŠ¸ì›Œí¬-ë„¤ì„ìŠ¤í˜ì´ìŠ¤-ì•ˆì—ì„œ-ì‹¤í–‰">3. ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì•ˆì—ì„œ ì‹¤í–‰</h2>

<ul>
  <li><code class="language-plaintext highlighter-rouge">arp</code> : í˜¸ìŠ¤íŠ¸ì—ì„œì˜ í•­ëª©ë“¤ ì¶œë ¥</li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ip netns exec red arp</code> : ì»¨í…Œì´ë„ˆì—ì„œì˜ í•­ëª©ë“¤ ì¶œë ¥</p>
  </li>
  <li><code class="language-plaintext highlighter-rouge">route</code> : í˜¸ìŠ¤íŠ¸ì—ì„œì˜ ë¼ìš°íŒ… í…Œì´ë¸” ì¶œë ¥</li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ip netns exec red route</code> : ì»¨í…Œì´ë„ˆì—ì„œì˜ ë¼ìš°íŒ… í…Œì´ë¸” ì¶œë ¥</p>
  </li>
  <li>2ê°œì˜ ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°„ì˜ í†µì‹ : ê°€ìƒ ì´ë”ë„· í˜ì–´ í˜¹ì€ ê°€ìƒ ì¼€ì´ë¸”(=íŒŒì´í”„)
    <ul>
      <li><code class="language-plaintext highlighter-rouge">ip link add veth-red type veth peer name veth-blue</code></li>
      <li><code class="language-plaintext highlighter-rouge">ip link set veth-red netns red</code> &amp; <code class="language-plaintext highlighter-rouge">ip link set veth-blue netns blue</code></li>
      <li>IP í• ë‹¹
        <ul>
          <li><code class="language-plaintext highlighter-rouge">ip -n red addr add 192.168.15.1 dev veth-red</code></li>
          <li><code class="language-plaintext highlighter-rouge">ip -n blue addr add 192.168.15.2 dev veth-blue</code></li>
        </ul>
      </li>
      <li>IP ë§í¬ ì—…
        <ul>
          <li><code class="language-plaintext highlighter-rouge">ip -n red link set veth-red up</code></li>
          <li><code class="language-plaintext highlighter-rouge">ip -n blue link set veth-blue up</code></li>
        </ul>
      </li>
      <li>í…ŒìŠ¤íŠ¸
        <ul>
          <li><code class="language-plaintext highlighter-rouge">ip netns exec red ping 192.168.15.2</code></li>
          <li><code class="language-plaintext highlighter-rouge">ip netns exec red arp</code></li>
          <li><code class="language-plaintext highlighter-rouge">ip netns exec blue arp</code>
            <ul>
              <li>ìƒëŒ€ë°©ì˜ mac/ipì£¼ì†Œ í‘œì‹œ</li>
            </ul>
          </li>
          <li><code class="language-plaintext highlighter-rouge">arp</code> : host ì˜ arp í…Œì´ë¸”
            <ul>
              <li>ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì˜ ì •ë³´ ì—†ìŒ</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p><br /></p>

<ul>
  <li>ê°€ìƒ ìŠ¤ìœ„ì¹˜ ìƒì„±
    <ul>
      <li>ê°€ìƒ ìŠ¤ìœ„ì¹˜ ìƒì„±í•˜ê³  ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì—°ê²°
        <ul>
          <li>Linux Bridge / Open vSwitchë¥¼ í†µí•´ ìƒì„± ê°€ëŠ¥</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p><br /></p>

<ul>
  <li>Linux Bridge
    <ul>
      <li><code class="language-plaintext highlighter-rouge">ip link add v-net-0 type bridge</code> : í˜¸ìŠ¤íŠ¸ì— ip ì¸í„°í˜ì´ìŠ¤ë¥¼ ì¶”ê°€ ( <code class="language-plaintext highlighter-rouge">ip link</code> ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŒ)</li>
      <li><code class="language-plaintext highlighter-rouge">ip link set dev v-net-0 up</code> : ë„¤íŠ¸ì›Œí¬ ë§í¬ í™œì„±í™”</li>
      <li>ê¸°ì¡´ ì§ì ‘ì—°ê²° ë§í¬ ì‚­ì œ
        <ul>
          <li><code class="language-plaintext highlighter-rouge">ip -n red link del veth-red</code>: í•œìª½ ë§í¬ ì‚­ì œí•˜ë©´ ë‹¤ë¥¸ìª½ ë§í¬ ìë™ ì‚­ì œë¨</li>
        </ul>
      </li>
      <li><code class="language-plaintext highlighter-rouge">ip link add veth-red type veth peer name vth-red-br</code></li>
      <li><code class="language-plaintext highlighter-rouge">ip link add veth-blue type veth peer name vth-blue-br</code></li>
      <li><code class="language-plaintext highlighter-rouge">ip link set veth-red netns red</code>
        <ul>
          <li><code class="language-plaintext highlighter-rouge">ip link set veth-red-br master v-net-0</code> : v-net-0(ìŠ¤ìœ„ì¹˜)ì— veth-red-br ì¸í„°í˜ì´ìŠ¤ ì—°ê²°</li>
          <li><code class="language-plaintext highlighter-rouge">ip -n red addr add 192.168.15.1 dev veth-red</code> : IP ì£¼ì†Œ ì—°ê²°</li>
          <li><code class="language-plaintext highlighter-rouge">ip -n red link set veth-red up</code>: ì¸í„°í˜ì´ìŠ¤ ë§í¬ í™œì„±í™”</li>
        </ul>
      </li>
      <li><code class="language-plaintext highlighter-rouge">ip link set veth-blue netns blue</code>
        <ul>
          <li><code class="language-plaintext highlighter-rouge">ip link set veth-blue-br master v-net-0</code>: v-net-0(ìŠ¤ìœ„ì¹˜)ì— veth-blue-br ì¸í„°í˜ì´ìŠ¤ ì—°ê²°</li>
          <li><code class="language-plaintext highlighter-rouge">ip -n blue addr add 192.168.15.2 dev veth-blue</code> : IPì£¼ì†Œ ì—°ê²°</li>
          <li><code class="language-plaintext highlighter-rouge">ip -n blue link set veth-blue up</code>: ì¸í„°í˜ì´ìŠ¤ ë§í¬ í™œì„±í™”</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p><br /></p>

<ul>
  <li>í˜¸ìŠ¤íŠ¸ì™€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°„ ì—°ê²°
    <ul>
      <li>ë¸Œë¦¬ì§€ìŠ¤ìœ„ì¹˜: í˜¸ìŠ¤í‹‘ì˜ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì¤‘ í•˜ë‚˜</li>
      <li><code class="language-plaintext highlighter-rouge">ip addr add 192.168.15.5/24 dev v-net-0</code> : í˜¸ìŠ¤íŠ¸ IP ì¶”ê°€</li>
      <li>ë¡œì»¬ í˜¸ìŠ¤íŠ¸ì—ì„œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì—°ê²°</li>
    </ul>
  </li>
</ul>

<p><br /></p>

<ul>
  <li>í˜¸ìŠ¤íŠ¸ ë°”ê¹¥ê³¼ í†µì‹ 
    <ul>
      <li>Blue namespace â‡’ í˜¸ìŠ¤íŠ¸ ë°”ê¹¥ ë§(192.168.1.3)
        <ul>
          <li><code class="language-plaintext highlighter-rouge">ip netns exec blue ping 192.168.1.3</code> â‡’ ë„ë‹¬í•˜ì§€ ì•ŠìŒ ( <code class="language-plaintext highlighter-rouge">ip netns exec blue route</code> í™•ì¸í•´ë³´ë©´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŒ)</li>
          <li>ë¼ìš°íŒ… í…Œì´ë¸”ì— í•­ëª©ì„ ì¶”ê°€í•´ ì™¸ë¶€ì— ëŒ€í•œ ê²Œì´íŠ¸ì›¨ì´ ì œê³µí•´ì•¼í•¨
            <ul>
              <li><code class="language-plaintext highlighter-rouge">ip netns exec blue ip route add 192.168.1.0/24 via 192.168.15.5</code> ë“±ë¡
                <ul>
                  <li>192.168.15.5 : v-net-0</li>
                  <li>Pingì´ ê°€ì§€ë§Œ ëŒì•„ì˜¤ì§€ ì•ŠìŒ</li>
                </ul>
              </li>
            </ul>

            <p>â‡’ NAT ì„ êµ¬ì„±í•´ì•¼í•¨</p>

            <ul>
              <li><code class="language-plaintext highlighter-rouge">iptables -t nat -A POSTROUTING -s 192.168.15.0/2 -j MASQUERADE</code></li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p><br /></p>

<ul>
  <li>ì¸í„°ë„·ì— ì—°ê²°
    <ul>
      <li><code class="language-plaintext highlighter-rouge">ip netns exec blue ip route add default via 192.168.15.5</code>
        <ul>
          <li>0.0.0.0 ì£¼ì†Œê°€ v-net-0ë¥¼ í†µí•´ ê°€ë„ë¡ ê²Œì´íŠ¸ì›¨ì´ êµ¬ì„±</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p><br /></p>

<ul>
  <li>ì™¸ë¶€ì—ì„œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ í†µì‹ 
    <ul>
      <li>ì™¸ë¶€ í˜¸ìŠ¤íŠ¸ì— Namespaceì˜ IP ë¼ìš°íŒ… ë“±ë¡: 192.168.15.5(v-net-0) via 192.168.1.2(eth0)</li>
      <li><code class="language-plaintext highlighter-rouge">iptables -t nat -A PREROUTING â€”dport 80 â€”to-destination 192.168.15.2:80 -j DNAT</code></li>
    </ul>
  </li>
</ul>
:ET