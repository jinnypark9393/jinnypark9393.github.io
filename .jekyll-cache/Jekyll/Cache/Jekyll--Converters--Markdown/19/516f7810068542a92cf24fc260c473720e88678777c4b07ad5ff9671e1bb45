I"¦<p><br /><br /></p>

<p><em>ğŸ’¡Â   TL;DR : NGINX Ingress Controller ì‚¬ìš© ì‹œ nginx.ingress.kubernetes.io ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•´ì•¼ Sticky session ë“±ì˜ ì„¤ì •ê°’ì´ ì ìš©ëœë‹¤(ì¼ë°˜ ingress.kubernetes.io ì„¤ì • ì ìš©ì‹œ ì„¤ì • ì ìš© ì•ˆë¨)</em></p>

<p><br /><br /></p>

<h1 id="1-ì—ëŸ¬-ìƒí™©">1. ì—ëŸ¬ ìƒí™©</h1>

<p>ì»¨í…Œì´ë„ˆ ì „í™˜ í”„ë¡œì íŠ¸ ì§„í–‰ ë„ì¤‘ Ingress Controllerë¥¼ Contourì—ì„œ NGINX-Ingress Controllerë¡œ ë³€ê²½ í›„, ì‹œìŠ¤í…œì— ê°„í—ì ìœ¼ë¡œ ì ‘ì†ì´ ë˜ì§€ ì•ŠëŠ” í˜„ìƒì´ ë°œìƒí–ˆë‹¤(êµ¬ì²´ì ìœ¼ë¡œëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ë¼ëŠ” í˜ì´ì§€ê°€ ëœ¨ë©° ì ‘ì†ì´ ë˜ì§€ ì•Šë‹¤ê°€ ìƒˆë¡œê³ ì¹¨ ì‹œ ì ‘ì†ì´ ë˜ëŠ” í˜„ìƒ).</p>

<p><br /><br /></p>

<p>í•´ë‹¹ ì‹œìŠ¤í…œì€ Multi Podë¡œ êµ¬ì„±ë˜ì–´ìˆì—ˆëŠ”ë°(replicas = 2), ê° Podë¡œê·¸ë¥¼ ë³´ë‹ˆ ì•„ë˜ì™€ ê°™ì€ SQL ì—ëŸ¬ê°€ ë°œìƒí•˜ê³  ìˆì—ˆë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error querying database. Cause: com.edb.util.SQLException: FATAL: terminating connection due to administrator <span class="nb">command</span>
</code></pre></div></div>

<p><br /><br /></p>

<p>ë¡œê·¸ë¥¼ ì¶”ê°€ì ìœ¼ë¡œ ì‚´í´ë³´ë‹ˆ user ì •ë³´ë¥¼ SELECTí•˜ëŠ” ë°ì—ì„œ ì˜¤ë¥˜ê°€ ë‚˜ê³  ìˆì—ˆê³ , ê° íŒŒë“œì—ì„œ ë¡œê·¸ì¸ ì•„ì´ë”” ì •ë³´ë¥¼ ì°ì–´ì£¼ëŠ” ë¡œê·¸ì— ì•„ë˜ì™€ ê°™ì€ ë¡œê·¸ê°€ ë°œìƒí•˜ê³  ìˆì—ˆë‹¤.</p>

<p><br /></p>

<ul>
  <li>Pod A ë¡œê·¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2022-MM-DD_hh:mm:ss.000:loginId<span class="o">=</span>null, /íŒŒì¼ê²½ë¡œ,
<span class="nv">clientTimezone</span><span class="o">=</span>Asia/Seoul
</code></pre></div></div>

<p><br /></p>

<ul>
  <li>Pod B ë¡œê·¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2022-MM-DD_hh:mm:ss.000:loginid<span class="o">=</span>canary,/íŒŒì¼ê²½ë¡œ,
<span class="nv">userId</span><span class="o">=</span>canary
</code></pre></div></div>

<p><br /><br /></p>

<p>ë¡œê·¸ì¸ ì•„ì´ë””ë¥¼ í•œìª½ì—ì„œë§Œ ë°›ì•„ì£¼ê³  ìˆì—ˆëŠ”ë°, ë¸Œë¼ìš°ì €ì—ì„œ ê´€ë¦¬ìë„êµ¬(F12í‚¤ë¡œ ê´€ë¦¬ì ë„êµ¬ ê¸°ë™ â‡’ Networkì—ì„œ JSESSIONID í™•ì¸) ë¡œ í™•ì¸í•´ë³´ë‹ˆ ìƒˆë¡œê³ ì¹¨ë§ˆë‹¤ ë‹¤ë¥¸ Podì—ì„œ ì„¸ì…˜ì„ ë°›ì•„ì˜¤ëŠ” <code class="language-plaintext highlighter-rouge">round robin</code> ë°©ì‹ìœ¼ë¡œ ì„¸ì…˜ ì„¤ì •ì´ ë˜ì–´ìˆì–´ ë¡œê·¸ì¸ ì •ë³´ê°€ ì €ì¥ë˜ì§€ ì•Šì€ Podì— ì ‘ê·¼í•  ë•Œ ì—ëŸ¬ê°€ ë‚˜ê³ ìˆì—ˆë‹¤.</p>

<p><br /><br /></p>

<p>ì¿ ë²„ë„¤í‹°ìŠ¤ ëŒ€ì‹œë³´ë“œì˜ Ingress ì„¤ì •ì„ í™•ì¸í•´ë³´ë‹ˆ, annotation ê°’ë“¤ì´ <code class="language-plaintext highlighter-rouge">nginx.ingress.kubernetes</code> (NGINX ingress controllerë¥¼ ì ìš©í–ˆì„ ë•Œì˜ ì„¤ì •)ê°€ ì•„ë‹Œ <code class="language-plaintext highlighter-rouge">ingress.kubernetes</code> , ì¦‰ <strong>ì¼ë°˜ ì¿ ë²„ë„¤í‹°ìŠ¤ ingress ê°ì²´ ì„¤ì •ìœ¼ë¡œ ë˜ì–´ìˆì–´ annotation ì„¤ì •ì´ ì ìš©ì´ ë˜ì§€ ì•Šê³  ìˆì—ˆë‹¤.</strong></p>

<p><br /><br /></p>

<h1 id="2-í•´ê²°-ë°©ë²•">2. í•´ê²° ë°©ë²•</h1>

<p>ë”°ë¼ì„œ í•´ë‹¹ ì„¤ì •ì„ ì•„ë˜ì™€ ê°™ì´ nginx.ingressë¡œ ë³€ê²½í•´ <code class="language-plaintext highlighter-rouge">round robin</code> ëŒ€ì‹   <code class="language-plaintext highlighter-rouge">sticky session</code>ì„ ì ìš©í–ˆë‹¤. <code class="language-plaintext highlighter-rouge">sticky sesison</code> ì ìš© í›„ ì‚¬ìš©ì ë¡œê·¸ì¸ ì •ë³´ê°€ ì €ì¥ëœ Podë¡œë§Œ ìš”ì²­ì´ ë¼ìš°íŒ…ë˜ì–´ ì—ëŸ¬ê°€ í•´ê²°ë˜ì—ˆë‹¤.</p>

<p><br /><br /></p>

<ul>
  <li>nginx-ingress.yaml ì„¤ì •</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">netwroking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
 <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-ingress</span>
 <span class="na">namespace</span><span class="pi">:</span> <span class="s">web-app</span>
 <span class="na">annotations</span><span class="pi">:</span>
  <span class="na">kubernetes.io/ingress.class</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">nginx.ingress.kuberentes.io/affinity</span><span class="pi">:</span> <span class="s">cookie</span>
  <span class="na">nginx.ingress.kuberentes.io/affinity-mode</span><span class="pi">:</span> <span class="s">persistent</span>
  <span class="na">nginx.ingress.kuberentes.io/session-cookie-expires</span><span class="pi">:</span> <span class="s1">'</span><span class="s">172800'</span>
  <span class="na">nginx.ingress.kuberentes.io/session--cookie-max-age</span><span class="pi">:</span> <span class="s1">'</span><span class="s">172800'</span>

<span class="s">(ì´í•˜ ìƒëµ)</span>

</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">kubernetes.io/ingress.class: nginx</code> : ì–´ë–¤ ì¸ê·¸ë ˆìŠ¤ë¥¼ ì“¸ ê²ƒì¸ì§€ ì„¤ì •</li>
  <li><code class="language-plaintext highlighter-rouge">nginx.ingress.kuberentes.io/affinity-mode: cookie</code> : ì„¸ì…˜ ì–´í”¼ë‹ˆí‹°(session affinity = sticky session) ì„¤ì • í™œì„±í™”. í˜„ì¬ NGINXì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ì–´í”¼ë‹ˆí‹° íƒ€ì…ì€ <code class="language-plaintext highlighter-rouge">cookie</code> í•˜ë‚˜ ë¿ì´ë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">nginx.ingress.kuberentes.io/affinity-mode: persistent</code> : ì–¼ë§ˆë‚˜ sticky í•˜ê²Œ ì„¤ì •í•  ê²ƒì¸ì§€ ì„¤ì •. <code class="language-plaintext highlighter-rouge">balanced</code> (ê¸°ë³¸ê°’) ê³¼ <code class="language-plaintext highlighter-rouge">persistent</code> ë‘ ê°€ì§€ê°€ ìˆë‹¤. Persistentë¡œ ì„¤ì •í•  ê²½ìš° Podê°€ í™•ì¥ë˜ì–´ë„ ì„œë²„ê°„ ë¶€í•˜ë¥¼ ë¶„ì‚°í•˜ì§€ ì•ŠëŠ”ë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">nginx.ingress.kuberentes.io/session-cookie-expires: '172800'</code> : ì¿ í‚¤ ë§Œë£Œì‹œê¹Œì§€ì˜ ì‹œê°„(ì´ˆ ë‹¨ìœ„)</li>
  <li><code class="language-plaintext highlighter-rouge">nginx.ingress.kuberentes.io/session--cookie-max-age: '172800'</code> : ì˜¤ë˜ëœ ë¸Œë¼ìš°ì €ì™€ í˜¸í™˜ë˜ëŠ” ì´ì „ ë²„ì „ì˜ Annotation ê°’. <code class="language-plaintext highlighter-rouge">Expires</code> ì¿ í‚¤ë¥¼ ìƒì„±í•¨.</li>
</ul>

<p><br /><br /></p>

<ul>
  <li>ì°¸ê³ 
    <ul>
      <li>NGINX Configuration (<a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/</a>)</li>
      <li>NGINX Examples Sticky Sessions (<a href="https://kubernetes.github.io/ingress-nginx/examples/affinity/cookie/">https://kubernetes.github.io/ingress-nginx/examples/affinity/cookie/</a>)</li>
    </ul>
  </li>
</ul>
:ET